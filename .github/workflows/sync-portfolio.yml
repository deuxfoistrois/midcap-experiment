#!/usr/bin/env python3
import os
import json
import requests
import pandas as pd
from datetime import datetime, timedelta
import alpaca_trade_api as tradeapi

def get_alpaca_client():
    """Initialize Alpaca client"""
    api_key = os.environ.get('ALPACA_API_KEY')
    secret_key = os.environ.get('ALPACA_SECRET_KEY')
    base_url = os.environ.get('ALPACA_BASE_URL', 'https://paper-api.alpaca.markets')
    
    if not api_key or not secret_key:
        raise ValueError("Alpaca API credentials not found in environment variables")
    
    return tradeapi.REST(api_key, secret_key, base_url, api_version='v2')

def sync_portfolio_with_alpaca():
    """Complete portfolio sync with Alpaca"""
    try:
        print("=== Portfolio Sync Starting ===")
        
        # Initialize Alpaca client
        api = get_alpaca_client()
        
        # Get account info
        account = api.get_account()
        print(f"Connected! Account status: {account.status}")
        
        # Get current positions from Alpaca
        positions = api.list_positions()
        current_symbols = [pos.symbol for pos in positions]
        print(f"Current positions: {current_symbols}")
        
        # Define experiment symbols
        experiment_symbols = ['CRNX', 'STRL', 'OTEX', 'ZION']
        
        # Check for missing positions (stop losses)
        missing_positions = set(experiment_symbols) - set(current_symbols)
        if missing_positions:
            for symbol in missing_positions:
                print(f"üö® {symbol} STOP LOSS DETECTED - Position not found in account")
        
        # Build experiment positions data
        experiment_positions = {}
        current_positions_value = 0.0
        
        for pos in positions:
            if pos.symbol in experiment_symbols:
                current_price = float(pos.market_value) / float(pos.qty)
                position_data = {
                    "symbol": pos.symbol,
                    "shares": float(pos.qty),
                    "entry_price": float(pos.avg_entry_price) if pos.avg_entry_price else current_price,
                    "current_price": current_price,
                    "market_value": float(pos.market_value),
                    "unrealized_pnl": float(pos.unrealized_pl),
                    "unrealized_pnl_pct": float(pos.unrealized_plpc),
                    "cost_basis": float(pos.cost_basis) if pos.cost_basis else float(pos.qty) * float(pos.avg_entry_price),
                    "last_update": datetime.now().isoformat()
                }
                experiment_positions[pos.symbol] = position_data
                current_positions_value += float(pos.market_value)
        
        # Calculate experiment cash (CRNX sale proceeds + original remaining cash)
        # Original investment: $1000, allocated ~$975 to positions, ~$25 remaining cash
        # CRNX sold for ~$268 (8 shares * $33.58 stop price)
        # Current experiment cash = original leftover + CRNX sale proceeds
        original_remaining_cash = 24.52  # From your original data
        crnx_sale_proceeds = 268.64 if 'CRNX' in missing_positions else 0.0
        experiment_cash = original_remaining_cash + crnx_sale_proceeds
        
        # Total experiment portfolio value = current positions + experiment cash
        total_experiment_value = current_positions_value + experiment_cash
        
        # Calculate returns based on original $1000 investment
        baseline_investment = 1000.0
        total_return = total_experiment_value - baseline_investment
        total_return_pct = (total_return / baseline_investment)
        
        print(f"Experiment symbols: {experiment_symbols}")
        print(f"Original investment: ${baseline_investment:.2f}")
        print(f"Current positions value: ${current_positions_value:.2f}")
        print(f"Experiment cash: ${experiment_cash:.2f}")
        print(f"Total experiment value: ${total_experiment_value:.2f}")
        print(f"Total return: ${total_return:.2f} ({total_return_pct:.2%})")
        
        # Create portfolio data structure
        portfolio_data = {
            "positions": experiment_positions,
            "cash": experiment_cash,
            "portfolio_value": total_experiment_value,
            "total_invested": baseline_investment,
            "total_return": total_return,
            "total_return_pct": total_return_pct,
            "positions_count": len(experiment_positions),
            "last_update": datetime.now().isoformat(),
            "experiment_start": "2025-09-08T00:00:00"
        }
        
        # Save to latest.json
        os.makedirs('data', exist_ok=True)
        with open('data/latest.json', 'w') as f:
            json.dump(portfolio_data, f, indent=2)
        
        # Update portfolio history CSV
        csv_data = {
            'date': datetime.now().strftime('%Y-%m-%d'),
            'portfolio_value': total_experiment_value,
            'cash': experiment_cash,
            'positions_value': current_positions_value,
            'total_invested': baseline_investment,
            'total_return': total_return,
            'total_return_pct': total_return_pct,
            'positions_count': len(experiment_positions)
        }
        
        # Add individual position data
        for symbol in experiment_symbols:
            if symbol in experiment_positions:
                pos = experiment_positions[symbol]
                csv_data[f'{symbol}_price'] = pos['current_price']
                csv_data[f'{symbol}_pnl'] = pos['unrealized_pnl']
                csv_data[f'{symbol}_pnl_pct'] = pos['unrealized_pnl_pct']
            else:
                # Position was sold (stop loss)
                csv_data[f'{symbol}_price'] = None
                csv_data[f'{symbol}_pnl'] = None
                csv_data[f'{symbol}_pnl_pct'] = None
        
        # Append to CSV
        df_new = pd.DataFrame([csv_data])
        csv_file = 'data/portfolio_history.csv'
        
        if os.path.exists(csv_file):
            df_existing = pd.read_csv(csv_file)
            # Remove today's entry if it exists
            df_existing = df_existing[df_existing['date'] != csv_data['date']]
            df_combined = pd.concat([df_existing, df_new], ignore_index=True)
        else:
            df_combined = df_new
        
        df_combined.to_csv(csv_file, index=False)
        
        print("‚úÖ Portfolio sync completed successfully")
        print(f"‚úÖ Updated files: data/latest.json, data/portfolio_history.csv")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error during portfolio sync: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    success = sync_portfolio_with_alpaca()
    if not success:
        exit(1)
