<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mid-Cap Portfolio Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .metric-card {
            text-align: center;
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
        }

        .metric-change {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .positive {
            color: #22c55e;
        }

        .negative {
            color: #ef4444;
        }

        .chart-container {
            grid-column: 1 / -1;
            height: 400px;
            position: relative;
        }

        .chart-container canvas {
            max-height: 350px;
        }

        .positions-table {
            grid-column: 1 / -1;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8fafc;
        }

        .symbol {
            font-weight: 700;
            color: #1f2937;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            color: #ef4444;
            text-align: center;
            padding: 20px;
            background: #fef2f2;
            border-radius: 8px;
            border: 1px solid #fecaca;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-value {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mid-Cap Portfolio Dashboard</h1>
            <p>Professional Catalyst-Driven Investment Strategy</p>
        </div>

        <div class="dashboard-grid">
            <div class="card metric-card">
                <div class="metric-value" id="portfolioValue">$0.00</div>
                <div class="metric-label">Portfolio Value</div>
                <div class="metric-change" id="portfolioChange">+$0.00 (0.00%)</div>
            </div>

            <div class="card metric-card">
                <div class="metric-value" id="totalReturn">$0.00</div>
                <div class="metric-label">Total Return</div>
                <div class="metric-change" id="returnPct">0.00%</div>
            </div>

            <div class="card metric-card">
                <div class="metric-value" id="positionsCount">0</div>
                <div class="metric-label">Active Positions</div>
                <div class="metric-change" id="cashAmount">Cash: $0.00</div>
            </div>

            <div class="card chart-container">
                <h3 style="margin-bottom: 20px; color: #374151;">Portfolio Performance</h3>
                <canvas id="performanceChart"></canvas>
            </div>

            <div class="card positions-table">
                <h3 style="margin-bottom: 20px; color: #374151;">Current Holdings</h3>
                <div class="table-wrapper">
                    <table id="positionsTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Shares</th>
                                <th>Entry Price</th>
                                <th>Current Price</th>
                                <th>Market Value</th>
                                <th>P&L</th>
                                <th>P&L %</th>
                                <th>Catalyst</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="loading">Loading positions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let performanceChart = null;

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatPercentage(value) {
            return (value * 100).toFixed(2) + '%';
        }

        function isValidNumber(value) {
            return typeof value === 'number' && !isNaN(value) && isFinite(value);
        }

        function updateMetrics(data) {
            const portfolioValue = data.portfolio_value || 0;
            const totalReturn = data.total_return || 0;
            const returnPct = data.total_return_pct || 0;
            const cash = data.cash || 0;
            const positionsCount = data.positions_count || 0;

            document.getElementById('portfolioValue').textContent = formatCurrency(portfolioValue);
            document.getElementById('totalReturn').textContent = formatCurrency(totalReturn);
            document.getElementById('positionsCount').textContent = positionsCount;
            document.getElementById('cashAmount').textContent = `Cash: ${formatCurrency(cash)}`;

            const returnElement = document.getElementById('returnPct');
            const changeElement = document.getElementById('portfolioChange');
            
            returnElement.textContent = formatPercentage(returnPct);
            changeElement.textContent = `${totalReturn >= 0 ? '+' : ''}${formatCurrency(totalReturn)} (${formatPercentage(returnPct)})`;
            
            const changeClass = totalReturn >= 0 ? 'positive' : 'negative';
            returnElement.className = `metric-change ${changeClass}`;
            changeElement.className = `metric-change ${changeClass}`;
        }

        function updatePositionsTable(positions) {
            const tbody = document.querySelector('#positionsTable tbody');
            
            if (!positions || Object.keys(positions).length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No positions found</td></tr>';
                return;
            }

            const rows = Object.values(positions).map(position => {
                const pnl = position.unrealized_pnl || 0;
                const pnlPct = position.unrealized_pnl_pct || 0;
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                
                return `
                    <tr>
                        <td class="symbol">${position.symbol || 'N/A'}</td>
                        <td>${(position.shares || 0).toFixed(3)}</td>
                        <td>${formatCurrency(position.entry_price || 0)}</td>
                        <td>${formatCurrency(position.current_price || 0)}</td>
                        <td>${formatCurrency(position.market_value || 0)}</td>
                        <td class="${pnlClass}">${formatCurrency(pnl)}</td>
                        <td class="${pnlClass}">${formatPercentage(pnlPct)}</td>
                        <td>${position.catalyst || 'No catalyst'}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function createPerformanceChart(csvData) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }

            if (!csvData || csvData.length === 0) {
                console.log('No CSV data available for chart');
                return;
            }

            // Filter and validate data
            const validData = csvData.filter(row => {
                const returnPct = parseFloat(row.total_return_pct);
                return isValidNumber(returnPct) && 
                       returnPct > -0.5 && 
                       returnPct < 2.0 && 
                       row.date;
            });

            if (validData.length === 0) {
                console.log('No valid data points for chart');
                return;
            }

            // Sort by date
            validData.sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = validData.map(row => {
                const date = new Date(row.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const portfolioData = validData.map(row => parseFloat(row.total_return_pct) * 100);

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio Return %',
                        data: portfolioData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: '#e5e7eb'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                },
                                color: '#6b7280'
                            }
                        },
                        x: {
                            grid: {
                                color: '#e5e7eb'
                            },
                            ticks: {
                                color: '#6b7280'
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverBackgroundColor: '#1d4ed8'
                        }
                    }
                }
            });
        }

        async function loadData() {
            try {
                // Load portfolio data
                const portfolioResponse = await fetch('docs/latest.json');
                if (!portfolioResponse.ok) {
                    throw new Error(`Failed to load portfolio data: ${portfolioResponse.status}`);
                }
                const portfolioData = await portfolioResponse.json();
                
                updateMetrics(portfolioData);
                updatePositionsTable(portfolioData.positions);

                // Load historical data for chart
                try {
                    const csvResponse = await fetch('data/portfolio_history.csv');
                    if (csvResponse.ok) {
                        const csvText = await csvResponse.text();
                        const csvData = csvText.split('\n')
                            .filter(line => line.trim())
                            .map((line, index) => {
                                if (index === 0) return null; // Skip header
                                const values = line.split(',');
                                return {
                                    date: values[0],
                                    total_return_pct: values[6]
                                };
                            })
                            .filter(row => row !== null);
                        
                        createPerformanceChart(csvData);
                    }
                } catch (csvError) {
                    console.log('Chart data not available:', csvError);
                }

            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('#positionsTable tbody').innerHTML = 
                    `<tr><td colspan="8" class="error">Error loading portfolio data: ${error.message}</td></tr>`;
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadData);
        
        // Refresh data every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>
