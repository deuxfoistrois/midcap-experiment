name: Portfolio Sync with Alpaca

on:
  schedule:
    - cron: '25 21 * * 1-5'  # 5 minutes before midcap_schedule
  workflow_dispatch:

jobs:
  sync-portfolio:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install pandas requests alpaca-py
        
    - name: Run portfolio sync
      env:
        ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
        ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL }}
      run: |
        python3 << 'EOF'
        import os
        import json
        import pandas as pd
        from datetime import datetime
        from alpaca.trading.client import TradingClient

        print("=== Portfolio Sync Starting ===")

        # Initialize Alpaca client
        api_key = os.environ.get('ALPACA_API_KEY')
        secret_key = os.environ.get('ALPACA_SECRET_KEY')
        base_url = os.environ.get('ALPACA_BASE_URL', 'https://paper-api.alpaca.markets')

        print(f"Connecting to: {base_url}")
        client = TradingClient(api_key, secret_key, paper=True)
        account = client.get_account()
        print(f"Connected! Account status: {account.status}")

        # Get current positions from Alpaca
        positions = client.get_all_positions()
        current_symbols = [pos.symbol for pos in positions if pos.symbol in ['CRNX', 'STRL', 'OTEX', 'ZION']]
        print(f"Current positions: {current_symbols}")

        # Load existing portfolio data (preserve original tracking)
        with open('docs/latest.json', 'r') as f:
            existing_portfolio = json.load(f)

        print("Existing portfolio data loaded")

        # Check for stop losses - only handle missing positions
        expected_symbols = set(['CRNX', 'STRL', 'OTEX', 'ZION'])
        current_symbols_set = set(current_symbols)
        sold_positions = expected_symbols - current_symbols_set

        # Calculate experiment cash
        experiment_cash = 24.52
        if 'CRNX' in sold_positions:
            print("CRNX stop loss detected - adding sale proceeds")
            experiment_cash += 268.64
            print(f"Added CRNX sale proceeds: $268.64")

        print(f"Experiment Cash: ${experiment_cash:.2f}")

        # Preserve existing position data, only update current prices for active positions
        updated_positions = {}
        
        # Keep all existing position data structure
        for symbol, existing_pos in existing_portfolio.get('positions', {}).items():
            if symbol in current_symbols:
                # Position still active - update only current price from Alpaca
                alpaca_pos = next((pos for pos in positions if pos.symbol == symbol), None)
                if alpaca_pos:
                    # Preserve all original tracking data, only update current price
                    current_price = float(alpaca_pos.market_value) / float(alpaca_pos.qty)
                    market_value = float(existing_pos.get('shares', 0)) * current_price
                    cost_basis = float(existing_pos.get('shares', 0)) * float(existing_pos.get('entry_price', 0))
                    unrealized_pnl = market_value - cost_basis
                    unrealized_pnl_pct = unrealized_pnl / cost_basis if cost_basis > 0 else 0
                    
                    updated_positions[symbol] = {
                        "symbol": symbol,
                        "shares": existing_pos.get('shares'),
                        "entry_price": existing_pos.get('entry_price'),  # PRESERVE original entry price
                        "current_price": current_price,
                        "market_value": market_value,
                        "cost_basis": cost_basis,
                        "unrealized_pnl": unrealized_pnl,
                        "unrealized_pnl_pct": unrealized_pnl_pct,
                        "catalyst": existing_pos.get('catalyst', 'No catalyst'),
                        "last_update": datetime.now().isoformat()
                    }
                    print(f"Updated {symbol}: ${current_price:.2f} (preserving original entry data)")
                else:
                    # Keep existing data if no Alpaca position found
                    updated_positions[symbol] = existing_pos
            # Skip positions that were sold (like CRNX)

        # Calculate totals
        positions_value = sum([pos['market_value'] for pos in updated_positions.values()])
        total_experiment_value = positions_value + experiment_cash
        baseline_investment = 1000.0
        total_return = total_experiment_value - baseline_investment
        total_return_pct = total_return / baseline_investment

        print(f"Positions Value: ${positions_value:.2f}")
        print(f"Total Value: ${total_experiment_value:.2f}")
        print(f"Total Return: ${total_return:.2f} ({total_return_pct:.2%})")

        # Update JSON file
        portfolio_data = {
            "positions": updated_positions,
            "cash": experiment_cash,
            "portfolio_value": total_experiment_value,
            "total_invested": baseline_investment,
            "total_return": total_return,
            "total_return_pct": total_return_pct,
            "positions_count": len(updated_positions),
            "last_update": datetime.now().isoformat(),
            "experiment_start": existing_portfolio.get("experiment_start", "2025-09-08T00:00:00")
        }

        with open('docs/latest.json', 'w') as f:
            json.dump(portfolio_data, f, indent=2)

        # Update CSV file only if there was a stop loss
        if sold_positions:
            try:
                df = pd.read_csv('data/portfolio_history.csv')
                
                target_date = '2025-09-19'
                if target_date in df['date'].values:
                    print(f"Updating CSV entry for {target_date}")
                    mask = df['date'] == target_date
                    df.loc[mask, 'cash'] = experiment_cash
                    df.loc[mask, 'portfolio_value'] = total_experiment_value
                    df.loc[mask, 'total_return'] = total_return
                    df.loc[mask, 'total_return_pct'] = total_return_pct
                    df.loc[mask, 'positions_count'] = len(updated_positions)
                    
                    df.to_csv('data/portfolio_history.csv', index=False)
                    print("CSV updated successfully")
                else:
                    print(f"Date {target_date} not found in CSV")
                    
            except Exception as e:
                print(f"CSV update failed: {e}")

        print("Portfolio sync completed successfully")
        EOF

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/latest.json data/portfolio_history.csv
        git commit -m "Update portfolio data - $(date)" || exit 0
        git push
